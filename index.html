<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CWRG Q&A">
  <title>CWRG Trade Q&A</title>
  <style>
    :root {
      --blue: #3B82F6;
      --orange: #F59E0B;
      --green: #10B981;
      --red: #EF4444;
      --gray-50: #F8FAFC;
      --gray-100: #F1F5F9;
      --gray-200: #E2E8F0;
      --gray-300: #CBD5E1;
      --gray-400: #94A3B8;
      --gray-500: #64748B;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1E293B;
      --gray-900: #0F172A;
      --card-bg: #FFFFFF;
      --body-bg: var(--gray-100);
      --text: var(--gray-900);
      --text-secondary: var(--gray-500);
      --border: var(--gray-200);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --card-bg: #1E293B;
        --body-bg: #0F172A;
        --text: #F1F5F9;
        --text-secondary: #94A3B8;
        --border: #334155;
        --gray-50: #1E293B;
        --gray-100: #0F172A;
        --gray-200: #334155;
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
      background: var(--body-bg); color: var(--text);
      height: 100dvh; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .header {
      padding: calc(var(--safe-top) + 8px) 16px 0;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .header-top {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
    }
    .header-title { font-size: 17px; font-weight: 700; letter-spacing: -0.3px; }
    .header-progress { font-size: 13px; color: var(--text-secondary); font-variant-numeric: tabular-nums; }
    .header-progress .count { font-weight: 600; color: var(--green); }
    .header-btn {
      background: var(--gray-50); border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 10px; font-size: 13px; color: var(--text-secondary); cursor: pointer;
      display: flex; align-items: center; gap: 4px;
    }
    .header-btn:active { opacity: 0.7; }
    .tabs {
      display: flex; gap: 6px; padding: 8px 0 10px;
      overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch;
    }
    .tabs::-webkit-scrollbar { display: none; }
    .tab {
      flex-shrink: 0; padding: 6px 14px; border-radius: 20px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      border: 2px solid transparent; background: var(--gray-50); color: var(--text-secondary);
      transition: all 0.15s;
    }
    .tab.active { color: #fff; }
    .tab[data-trade="All"].active { background: var(--gray-700); border-color: var(--gray-700); }
    .tab[data-trade="Electrician"].active { background: var(--blue); border-color: var(--blue); }
    .tab[data-trade="B.C. Heating"].active { background: var(--orange); border-color: var(--orange); }
    .tab[data-trade="Client"].active { background: var(--green); border-color: var(--green); }
    .tab[data-trade="Notes"].active { background: #8B5CF6; border-color: #8B5CF6; }
    .card-area { flex: 1; overflow: hidden; position: relative; padding: 12px 16px; }
    .card {
      background: var(--card-bg); border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
      height: 100%; display: flex; flex-direction: column; overflow: hidden;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    .card.slide-left { transform: translateX(-30px); opacity: 0; }
    .card.slide-right { transform: translateX(30px); opacity: 0; }
    .card-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px; }
    .card-trade {
      display: inline-block; padding: 3px 10px; border-radius: 12px;
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: #fff; margin-bottom: 10px;
    }
    .card-trade.Electrician { background: var(--blue); }
    .card-trade.BC-Heating { background: var(--orange); }
    .card-trade.Client { background: var(--green); }
    .card-id { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 4px; }
    .card-question { font-size: 20px; font-weight: 700; line-height: 1.3; margin-bottom: 10px; letter-spacing: -0.3px; }
    .card-detail { font-size: 15px; line-height: 1.5; color: var(--text-secondary); margin-bottom: 12px; }
    .card-why { margin-bottom: 16px; }
    .card-why summary {
      font-size: 13px; font-weight: 600; color: var(--text-secondary);
      cursor: pointer; padding: 8px 0; list-style: none;
    }
    .card-why summary::before {
      content: '\25B6\FE0E'; display: inline-block; margin-right: 6px;
      font-size: 10px; transition: transform 0.2s;
    }
    .card-why[open] summary::before { transform: rotate(90deg); }
    .why-text {
      font-size: 13px; line-height: 1.5; color: var(--text-secondary);
      padding: 4px 0 8px 18px; font-style: italic;
      border-left: 2px solid var(--border); margin-left: 2px;
    }
    .status-row { display: flex; gap: 6px; margin-bottom: 14px; }
    .status-btn {
      flex: 1; padding: 8px 6px; border-radius: 10px; border: 2px solid var(--border);
      background: transparent; font-size: 12px; font-weight: 600;
      color: var(--text-secondary); cursor: pointer; transition: all 0.15s; text-align: center;
    }
    .status-btn:active { transform: scale(0.97); }
    .status-btn.active[data-status="unanswered"] { border-color: var(--gray-400); background: var(--gray-200); color: var(--gray-700); }
    .status-btn.active[data-status="answered"] { border-color: var(--green); background: #D1FAE5; color: #065F46; }
    .status-btn.active[data-status="follow-up"] { border-color: var(--orange); background: #FEF3C7; color: #92400E; }
    @media (prefers-color-scheme: dark) {
      .status-btn.active[data-status="answered"] { background: #064E3B; color: #6EE7B7; }
      .status-btn.active[data-status="follow-up"] { background: #78350F; color: #FCD34D; }
      .status-btn.active[data-status="unanswered"] { background: var(--gray-700); color: var(--gray-300); }
    }
    .answer-wrap { position: relative; }
    .answer-textarea {
      width: 100%; min-height: 100px; padding: 12px;
      border: 2px solid var(--border); border-radius: 12px;
      font-size: 16px; font-family: inherit; line-height: 1.5; resize: vertical;
      background: var(--gray-50); color: var(--text); transition: border-color 0.15s;
    }
    .answer-textarea:focus { outline: none; border-color: var(--blue); }
    .answer-textarea::placeholder { color: var(--gray-400); }
    .mic-btn {
      position: absolute; right: 8px; bottom: 8px;
      width: 40px; height: 40px; border-radius: 50%; border: none;
      background: var(--gray-200); color: var(--gray-600); font-size: 18px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .mic-btn:active { transform: scale(0.9); }
    .mic-btn.recording { background: var(--red); color: #fff; animation: pulse 1.5s infinite; }
    .mic-btn.unavailable { opacity: 0.3; cursor: not-allowed; }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
    }
    .mic-interim { font-size: 13px; color: var(--text-secondary); font-style: italic; padding: 6px 0; min-height: 20px; }
    .voice-notes { margin-top: 8px; }
    .voice-notes summary { font-size: 12px; color: var(--text-secondary); cursor: pointer; padding: 4px 0; }
    .voice-note-item { font-size: 12px; color: var(--text-secondary); padding: 4px 0; border-bottom: 1px solid var(--border); }
    .voice-note-item .vn-time { font-weight: 600; font-variant-numeric: tabular-nums; }
    .footer {
      padding: 10px 16px calc(var(--safe-bottom) + 10px);
      background: var(--card-bg); border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .nav-btn {
      padding: 10px 20px; border-radius: 10px; border: none;
      font-size: 15px; font-weight: 600; cursor: pointer;
      background: var(--blue); color: #fff; min-width: 80px; transition: all 0.15s;
    }
    .nav-btn:active { transform: scale(0.97); opacity: 0.8; }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .nav-btn.secondary { background: var(--gray-200); color: var(--gray-700); }
    @media (prefers-color-scheme: dark) { .nav-btn.secondary { background: var(--gray-700); color: var(--gray-300); } }
    .nav-position { font-size: 14px; font-weight: 600; color: var(--text-secondary); font-variant-numeric: tabular-nums; }
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 100;
      align-items: flex-end; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-sheet {
      background: var(--card-bg); border-radius: 16px 16px 0 0;
      padding: 20px; padding-bottom: calc(var(--safe-bottom) + 20px);
      width: 100%; max-width: 500px;
    }
    .modal-sheet h3 { font-size: 17px; font-weight: 700; margin-bottom: 16px; }
    .modal-action {
      display: flex; align-items: center; gap: 12px;
      padding: 14px; border-radius: 12px; cursor: pointer;
      transition: background 0.1s; border: none; background: none;
      width: 100%; text-align: left; color: var(--text); font-size: 15px;
    }
    .modal-action:active { background: var(--gray-100); }
    .modal-action .ma-icon {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .modal-action .ma-label { font-weight: 600; }
    .modal-action .ma-desc { font-size: 12px; color: var(--text-secondary); }
    .modal-cancel {
      margin-top: 8px; width: 100%; padding: 14px; border-radius: 12px;
      border: none; background: var(--gray-200);
      font-size: 15px; font-weight: 600; color: var(--text); cursor: pointer;
    }
    .empty-state {
      display: none; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; color: var(--text-secondary);
      text-align: center; padding: 20px;
    }
    .empty-state.visible { display: flex; }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-msg { font-size: 15px; }
    .card-content { display: block; }
    .card-content.hidden { display: none; }
    #importFile { display: none; }

    /* ====== NOTES VIEW ====== */
    .notes-view { display: none; flex-direction: column; height: 100%; }
    .notes-view.visible { display: flex; }
    .notes-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 12px 16px; }
    .note-item {
      background: var(--card-bg); border-radius: 12px; padding: 14px 16px;
      margin-bottom: 8px; cursor: pointer; transition: transform 0.1s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .note-item:active { transform: scale(0.98); }
    .note-item-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .note-item-preview { font-size: 13px; color: var(--text-secondary); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .note-item-meta { font-size: 11px; color: var(--gray-400); margin-top: 6px; font-variant-numeric: tabular-nums; }
    .note-item-tag {
      display: inline-block; padding: 1px 6px; border-radius: 6px;
      font-size: 10px; font-weight: 700; color: #fff; margin-left: 6px; vertical-align: middle;
    }
    .notes-empty { text-align: center; color: var(--text-secondary); padding: 40px 20px; }
    .notes-empty-icon { font-size: 40px; margin-bottom: 8px; }

    .note-editor { display: none; flex-direction: column; height: 100%; padding: 12px 16px; }
    .note-editor.visible { display: flex; }
    .note-editor-title {
      width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px;
      font-size: 17px; font-weight: 600; font-family: inherit;
      background: var(--gray-50); color: var(--text); margin-bottom: 8px;
    }
    .note-editor-title:focus { outline: none; border-color: var(--blue); }
    .note-editor-body {
      flex: 1; width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px;
      font-size: 16px; font-family: inherit; line-height: 1.5; resize: none;
      background: var(--gray-50); color: var(--text);
    }
    .note-editor-body:focus { outline: none; border-color: var(--blue); }
    .note-tag-row { display: flex; gap: 6px; margin: 8px 0; flex-wrap: wrap; }
    .note-tag-btn {
      padding: 4px 10px; border-radius: 8px; border: 2px solid var(--border);
      background: transparent; font-size: 12px; font-weight: 600;
      color: var(--text-secondary); cursor: pointer;
    }
    .note-tag-btn.active { color: #fff; }
    .note-tag-btn[data-tag="Electrician"].active { background: var(--blue); border-color: var(--blue); }
    .note-tag-btn[data-tag="B.C. Heating"].active { background: var(--orange); border-color: var(--orange); }
    .note-tag-btn[data-tag="Client"].active { background: var(--green); border-color: var(--green); }
    .note-tag-btn[data-tag="General"].active { background: var(--gray-600); border-color: var(--gray-600); }
    .note-footer { display: flex; gap: 8px; padding-top: 10px; }
    .note-footer .nav-btn { flex: 1; }
    .note-delete-btn {
      padding: 10px 16px; border-radius: 10px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer;
      background: #FEE2E2; color: var(--red);
    }
    @media (prefers-color-scheme: dark) { .note-delete-btn { background: #450a0a; } }
    .footer.hidden { display: none; }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-top">
      <div>
        <div class="header-title">CWRG Trade Q&A</div>
        <div class="header-progress"><span class="count" id="answeredCount">0</span> of <span id="totalCount">0</span> answered</div>
      </div>
      <div>
        <button class="header-btn" id="menuBtn" aria-label="Menu">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 4h12M2 8h12M2 12h12"/></svg>
        </button>
      </div>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>

  <div class="card-area" id="cardArea">
    <div class="card" id="card">
      <div class="card-scroll" id="cardScroll">
        <!-- Empty state -->
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">&#x2705;</div>
          <div class="empty-msg">No questions for this filter</div>
        </div>
        <!-- Card content (static DOM, updated via textContent) -->
        <div class="card-content" id="cardContent">
          <div class="card-trade" id="tradeBadge"></div>
          <div class="card-id" id="questionId"></div>
          <div class="card-question" id="questionTitle"></div>
          <div class="card-detail" id="questionDetail"></div>
          <details class="card-why" id="whyDetails">
            <summary>Why it matters</summary>
            <div class="why-text" id="whyText"></div>
          </details>
          <div class="status-row">
            <button class="status-btn" data-status="unanswered" id="btnUnanswered">Unanswered</button>
            <button class="status-btn" data-status="answered" id="btnAnswered">Answered</button>
            <button class="status-btn" data-status="follow-up" id="btnFollowup">Follow-up</button>
          </div>
          <div class="answer-wrap">
            <textarea class="answer-textarea" id="answerInput" placeholder="Tap to type answer, or use mic..."></textarea>
            <button class="mic-btn" id="micBtn">&#x1F3A4;</button>
          </div>
          <div class="mic-interim" id="micInterim"></div>
          <div id="voiceNotesContainer"></div>
        </div>
      </div>
    </div>

    <!-- Notes list view -->
    <div class="notes-view" id="notesView">
      <div class="notes-list" id="notesList"></div>
    </div>

    <!-- Note editor view -->
    <div class="note-editor" id="noteEditor">
      <input class="note-editor-title" id="noteTitleInput" type="text" placeholder="Note title...">
      <div class="note-tag-row" id="noteTagRow">
        <button class="note-tag-btn" data-tag="General">General</button>
        <button class="note-tag-btn" data-tag="Electrician">Electrician</button>
        <button class="note-tag-btn" data-tag="B.C. Heating">B.C. Heating</button>
        <button class="note-tag-btn" data-tag="Client">Client</button>
      </div>
      <textarea class="note-editor-body" id="noteBodyInput" placeholder="Write your note..."></textarea>
      <div class="note-footer">
        <button class="nav-btn secondary" id="noteBackBtn">Back</button>
        <button class="note-delete-btn" id="noteDeleteBtn" style="display:none">Delete</button>
        <button class="nav-btn" id="noteSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <div class="footer" id="footer">
    <button class="nav-btn secondary" id="prevBtn">Prev</button>
    <span class="nav-position" id="navPos">1 / 1</span>
    <button class="nav-btn" id="nextBtn">Next</button>
    <button class="nav-btn" id="addNoteBtn" style="display:none;width:100%">+ New Note</button>
  </div>

  <div class="modal-overlay" id="menuModal">
    <div class="modal-sheet" id="modalSheet">
      <h3>Data Sync</h3>
      <button class="modal-action" id="btnExport">
        <div class="ma-icon" style="background:#DBEAFE;color:var(--blue)">&#x1F4BE;</div>
        <div><div class="ma-label">Save to File</div><div class="ma-desc">Export answers as JSON for iCloud sync</div></div>
      </button>
      <button class="modal-action" id="btnImport">
        <div class="ma-icon" style="background:#D1FAE5;color:var(--green)">&#x1F4C2;</div>
        <div><div class="ma-label">Load from File</div><div class="ma-desc">Import answers from JSON file</div></div>
      </button>
      <button class="modal-action" id="btnClear">
        <div class="ma-icon" style="background:#FEE2E2;color:var(--red)">&#x1F5D1;</div>
        <div><div class="ma-label">Clear All Answers</div><div class="ma-desc">Reset all answers and statuses</div></div>
      </button>
      <button class="modal-cancel" id="btnModalCancel">Cancel</button>
    </div>
  </div>

  <input type="file" id="importFile" accept=".json">

<script>
// ====== QUESTION DATA (all hardcoded, never from user input) ======
const QUESTIONS = [
  {id:"E1",trade:"Electrician",question:"Exterior flood circuits \u2014 dedicated breakers?",detail:"Will the front and back exterior flood zones each get their own breaker, or will they share a breaker (or share with other circuits)?",why:"The Shelly Wave Pro 2PM DIN relay needs to sit inline on a dedicated circuit per zone. If floods share a breaker with other loads (outlets, interior lights), the relay would cut power to those too. Need 2 dedicated breakers (1 front floods, 1 back floods) for clean smart control."},
  {id:"E2",trade:"Electrician",question:"Exterior flood fixture selection",detail:"What motion-activated flood fixtures are being installed? Wattage? LED? How many fixtures per zone (front and back)?",why:"Shelly Wave Pro 2PM relay is rated 16A combined / 10A per channel. Need to confirm total wattage per zone stays within relay capacity. Motion-activated floods are binary on/off \u2014 dimming not needed."},
  {id:"E3",trade:"Electrician",question:"Exterior flood wiring topology",detail:"Will feeds run direct from panel to fixture, or through any junction boxes / switch boxes along the way?",why:"If routed through a switch box (even without installing a switch), that gives a future option for a wall switch or in-wall relay. If direct panel-to-fixture, DIN rail at the panel is the only smart control option."},
  {id:"E4",trade:"Electrician",question:"DIN rail space at panel",detail:"Is there room in or adjacent to the Siemens 400A panel for a small DIN rail module (1\u00d7 Shelly Wave Pro 2PM, ~35mm wide)? Or should we plan a separate small DIN enclosure on the wall nearby?",why:"The Shelly module mounts on standard 35mm DIN rail. Could go inside the panel (if there\u2019s rail space), on a small DIN enclosure beside it, or in the network rack area (east wall, very close to panel)."},
  {id:"E5",trade:"Electrician",question:"Interior switch box locations",detail:"Where exactly are the 4 interior lighting switch boxes being placed? Near front door? Near back door? Grouped together? Multiple locations?",why:"Affects cable run lengths and 3-way planning. If there\u2019s only one switch location (e.g., near front door), someone entering from the back door can\u2019t control lights without HA/voice. If 2 locations, may need 3-way wiring on some zones."},
  {id:"E6",trade:"Electrician",question:"3-way requirement for interior",detail:"Do any of the 4 interior lighting zones need 3-way switching (controllable from 2 wall locations)?",why:"ZEN77 supports 3-way with a companion switch (Zooz ZEN74) or via Z-Wave association. If 3-way wiring (traveler wire) is needed, it must be run now while walls are open. Without physical 3-way wiring, we can still do virtual 3-way via HA automations + a battery remote at the second location."},
  {id:"E7",trade:"Electrician",question:"Interior lighting zone assignments",detail:"How are the 8 pendant lights + 4 wall sconces split across the 4 interior dimmer zones? Which fixtures on which circuit?",why:"Need total wattage per zone for ZEN77 sizing (max 100W LED per ZEN77) and to plan HA automations (which zone controls which area of the room)."},
  {id:"E8",trade:"Electrician",question:"Interior fixtures \u2014 dimmable?",detail:"Are all interior pendants and sconces being fitted with dimmable LED bulbs/drivers?",why:"ZEN77 is a dimmer \u2014 non-dimmable LEDs will flicker or buzz. Need to confirm all fixtures on dimmer circuits use dimmable-rated LED drivers."},
  {id:"E9",trade:"Electrician",question:"Versant 280 \u2014 dedicated circuit?",detail:"Is a dedicated 240V/30A circuit available for the Versant 280 Press, or does a new circuit need to be run from the panel?",why:"The Versant 280 requires 240V/30A (2.8\u20133.1 kVA). If no existing circuit, electrician needs to run one during this phase. Coordinate with client on exact printer placement."},
  {id:"E10",trade:"Electrician",question:"Low-voltage brackets \u2014 Carlon SC100A installation",detail:"Install 8\u00d7 Carlon SC100A new-work nail-on low-voltage brackets at these 6 wall plate locations (+ 2 spare): 1) Desk 1 (south wall), 2) Desk 2 (south wall), 3) Versant 280 (east wall), 4) Reception (front/south), 5) Kitchen Eth (kitchen bar), 6) Chime (coffee bar). Nail to stud before drywall. Each bracket gets a single-gang keystone wall plate after drywall.",why:"SC100A brackets define clean rectangular openings for ethernet keystone wall plates. Must be installed during rough-in before drywall. Open-back design \u2014 NEC exempts Cat6 from enclosed boxes. $2.92/ea at Home Depot San Bernardino (Aisle 60, Bay 006). PoE devices (cameras, AP, sensors) do NOT need brackets \u2014 they mount directly over cable exit."},
  {id:"E11",trade:"Electrician",question:"Speaker pre-construction brackets \u2014 HTD BRX-W65 installation",detail:"Install 6\u00d7 HTD BRX-W65 speaker brackets at these positions (nail across studs before drywall): L1 (south wall ~7ft from SW corner, 7.5ft high), L2 (west wall ~7ft from SW corner, 7.5ft high), B1 (north wall ~8ft from NW corner, 8.5ft high), B2 (east wall back half, 8.5ft high), L3 (south wall ~14ft from SW corner \u2014 Phase 2 pre-wire), L4 (west wall ~14ft from SW corner \u2014 Phase 2 pre-wire). Verify 3.5\u201d cavity depth at each location before installing.",why:"BRX-W65 brackets create precise cutouts for HTD SDX-W65 in-wall speakers (3-3/8\u201d mounting depth). Drywallers roto-zip around the bracket \u2014 same workflow as can lights. If any location has <3.5\u201d cavity depth, flag it so we can use surface-mount speaker there instead. $16/ea from htd.com."},
  {id:"H1",trade:"B.C. Heating",question:"Is the outdoor unit truly inverter-driven?",detail:"Is the outdoor unit truly inverter-driven or is \u2018slim line inverter\u2019 just a model name?",why:"If truly inverter-driven, conventional thermostat wiring loses variable-speed modulation (falls back to fixed-stage operation). This affects our entire smart thermostat strategy."},
  {id:"H2",trade:"B.C. Heating",question:"Standard 5-wire thermostat compatible?",detail:"Will the system work with a standard 5-wire thermostat (R, W, Y, G, C)?",why:"Our Honeywell T6 Pro Z-Wave thermostat uses conventional 5-wire wiring. Need confirmation the HVAC system supports this without losing critical functionality."},
  {id:"H3",trade:"B.C. Heating",question:"Proprietary communication wire needed?",detail:"Does the inverter unit require any proprietary communication wire to the air handler?",why:"Proprietary wiring (e.g., communicating bus) may be required alongside or instead of standard thermostat cable. Affects what wire the HVAC installer runs."},
  {id:"H4",trade:"B.C. Heating",question:"Dual terminal sets on control board?",detail:"Does the HVAC control board have BOTH communicating AND conventional terminal sets?",why:"If the board has both terminal sets, we can potentially wire both thermostats simultaneously and switch between them using a relay."},
  {id:"H5",trade:"B.C. Heating",question:"Simultaneous wiring / mode selection?",detail:"If the board has both terminal sets \u2014 can both be wired simultaneously, with the board auto-detecting which is active? Or is there a DIP switch/jumper to select mode?",why:"Determines whether the dual-thermostat relay approach is viable without manually switching the board between modes."},
  {id:"H6",trade:"B.C. Heating",question:"Dual thermostat relay proposal \u2014 feasible?",detail:"We want to use the York communicating thermostat (pre-set to comfort temps) when occupied, and switch to the Honeywell Z-Wave (for HA-controlled setback temps) when dormant. A Z-Wave relay (Zooz ZEN17) would switch 24V power between the two thermostats so only one is active at a time. Is this feasible with this unit? Any concerns with switchover timing or compressor protection?",why:"This is the key question for our HVAC automation strategy. If feasible, we get best of both worlds: York inverter efficiency when occupied, Z-Wave remote control when vacant."},
  {id:"H7",trade:"B.C. Heating",question:"Alternative integration options?",detail:"If dual-thermostat isn\u2019t feasible, is there any way to integrate the York communicating thermostat with a third-party automation system (dry contacts, WiFi module, etc.)?",why:"Fallback plan if the dual-thermostat approach doesn\u2019t work. We need some way to control HVAC remotely via Home Assistant."},
  {id:"C1",trade:"Client",question:"Temperature setpoints per mode",detail:"What temperatures do you want for dormant mode (nobody here), semi-dormant (expected soon), and occupied mode?",why:"Needed to program the thermostat automation modes in Home Assistant. E.g., dormant=55\u00b0F, semi-dormant=65\u00b0F, occupied=72\u00b0F."},
  {id:"C2",trade:"Client",question:"Music source preference",detail:"Apple Music, Spotify, or other? Which streaming service do you primarily use?",why:"Determines which music integration to configure in Home Assistant and UniFi Play. Also affects whether we need AirPlay support."},
  {id:"C3",trade:"Client",question:"Existing phone number to port?",detail:"Is there an existing business phone number to port to the new system? (Phase 2/3 \u2014 not urgent)",why:"UniFi Talk setup requires knowing if we\u2019re porting an existing number or getting a new one. Porting takes 2-4 weeks."},
  {id:"C4",trade:"Client",question:"Mobile softphone needed?",detail:"Do you need a softphone app on your mobile for the office phone system? (Phase 2/3 \u2014 not urgent)",why:"Affects UniFi Talk licensing ($9.99/mo per line) and whether we set up the mobile app."},
  {id:"C5",trade:"Client",question:"Spectrum Business speed tier & demarc",detail:"What speed tier is the Spectrum Business internet? Where will the modem/demarc be located in the building?",why:"Determines WAN throughput for the UCG-Fiber gateway. Modem placement affects cable run to network rack (modem sits on shared shelf in rack)."},
  {id:"C6",trade:"Client",question:"Versant 280 \u2014 dedicated circuit?",detail:"Confirm: is a dedicated 240V/30A circuit available for the Versant 280 Press, or does a new circuit need to be run from the panel? Coordinate with electrician.",why:"The Versant 280 requires 240V/30A (2.8\u20133.1 kVA). If no existing circuit, electrician needs to run one during this phase."},
  {id:"C7",trade:"Client",question:"Versant 280 exact placement",detail:"Confirm exact placement of the Versant 280 in the back half of the building. It\u2019s ~10ft long with finisher.",why:"Affects Ethernet cable run length and route from network rack, plus the 240V circuit route."},
  {id:"C8",trade:"Client",question:"Speaker tier selection",detail:"Option A (Recommended): HTD SDX-W65 in-wall, $278 for 4 speakers + $96 for 6 pre-construction brackets (BRX-W65) = $374 total. Flush mount, aimable 15\u00b0 tweeter, +/-3dB tweeter level switch, fits 3.5\u201d cavity. Option B: Polk OWM3 on-wall, $298 for 4. Visible surface mount, full-body tilt aim. HTD recommended \u2014 flush aesthetics, aimable tweeter for high mounting, only $44 more than OWM3 after brackets.",why:"Need to order speakers + pre-construction brackets before drywall. BRX-W65 brackets must be installed during rough-in (nail across studs). Drywallers cut the openings. Verify 3.5\u201d cavity depth at each speaker location."},
  {id:"C9",trade:"Client",question:"Security monitoring preference",detail:"Self-monitored (free \u2014 HA alerts only), Noonlight via HA ($10/mo \u2014 professional dispatch), or SimpliSafe ($23/mo \u2014 full monitoring)?",why:"Determines whether additional monitoring hardware or subscriptions are needed. Self-monitored means you get phone alerts; professional means dispatch calls police/fire."},
  {id:"C10",trade:"Client",question:"Desk monitor selection",detail:"Dell U2725QE hub monitor (has built-in 2.5GbE + KVM, could replace CalDigit TS4 dock, saving ~$300/desk) vs separate monitors + CalDigit TS4 docks?",why:"If Dell hub monitors are chosen, may not need CalDigit TS4 docks, changing the desk topology and saving ~$600 total."}
];

const TRADES = [
  {name:"All",color:"#334155"},
  {name:"Electrician",color:"#3B82F6"},
  {name:"B.C. Heating",color:"#F59E0B"},
  {name:"Client",color:"#10B981"},
  {name:"Notes",color:"#8B5CF6"}
];

// ====== STATE ======
let state = { currentIndex: 0, filter: "All", answers: {}, notes: [] };
const STORAGE_KEY = "cwrg-trade-qa-v1";
let currentQuestionId = null;
let currentNoteIndex = -1; // -1 = new note, >=0 = editing existing
let currentView = "questions"; // "questions" | "notes-list" | "note-editor"

// ====== DOM REFS ======
const els = {
  tabs: document.getElementById("tabs"),
  card: document.getElementById("card"),
  cardContent: document.getElementById("cardContent"),
  emptyState: document.getElementById("emptyState"),
  tradeBadge: document.getElementById("tradeBadge"),
  questionId: document.getElementById("questionId"),
  questionTitle: document.getElementById("questionTitle"),
  questionDetail: document.getElementById("questionDetail"),
  whyDetails: document.getElementById("whyDetails"),
  whyText: document.getElementById("whyText"),
  answerInput: document.getElementById("answerInput"),
  micBtn: document.getElementById("micBtn"),
  micInterim: document.getElementById("micInterim"),
  voiceNotes: document.getElementById("voiceNotesContainer"),
  navPos: document.getElementById("navPos"),
  prevBtn: document.getElementById("prevBtn"),
  nextBtn: document.getElementById("nextBtn"),
  answeredCount: document.getElementById("answeredCount"),
  totalCount: document.getElementById("totalCount"),
  menuModal: document.getElementById("menuModal"),
  modalSheet: document.getElementById("modalSheet"),
  importFile: document.getElementById("importFile"),
  // Notes
  notesView: document.getElementById("notesView"),
  notesList: document.getElementById("notesList"),
  noteEditor: document.getElementById("noteEditor"),
  noteTitleInput: document.getElementById("noteTitleInput"),
  noteBodyInput: document.getElementById("noteBodyInput"),
  noteTagRow: document.getElementById("noteTagRow"),
  noteBackBtn: document.getElementById("noteBackBtn"),
  noteDeleteBtn: document.getElementById("noteDeleteBtn"),
  noteSaveBtn: document.getElementById("noteSaveBtn"),
  addNoteBtn: document.getElementById("addNoteBtn")
};

// ====== PERSISTENCE ======
function save() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const saved = JSON.parse(raw);
      if (saved.answers) state.answers = saved.answers;
      if (saved.filter) state.filter = saved.filter;
      if (typeof saved.currentIndex === "number") state.currentIndex = saved.currentIndex;
      if (Array.isArray(saved.notes)) state.notes = saved.notes;
    }
  } catch(e) {}
}

// ====== HELPERS ======
function getAnswer(id) {
  return state.answers[id] || { answer: "", status: "unanswered", voiceNotes: [], lastModified: null };
}

function setAnswer(id, data) {
  state.answers[id] = Object.assign({}, getAnswer(id), data, { lastModified: new Date().toISOString() });
  save();
  updateProgress();
}

function filtered() {
  if (state.filter === "All") return QUESTIONS;
  return QUESTIONS.filter(function(q) { return q.trade === state.filter; });
}

function tradeClass(trade) {
  return trade.replace(/[\.\s]/g, "-");
}

// ====== RENDER TABS (safe DOM creation) ======
function renderTabs() {
  while (els.tabs.firstChild) els.tabs.removeChild(els.tabs.firstChild);

  TRADES.forEach(function(t) {
    var tab = document.createElement("div");
    tab.className = "tab" + (state.filter === t.name ? " active" : "");
    tab.setAttribute("data-trade", t.name);

    if (t.name === "Notes") {
      tab.textContent = "Notes" + (state.notes.length > 0 ? " " + state.notes.length : "");
    } else {
      var qs = t.name === "All" ? QUESTIONS : QUESTIONS.filter(function(q) { return q.trade === t.name; });
      var answered = qs.filter(function(q) { return getAnswer(q.id).status === "answered"; }).length;
      tab.textContent = t.name + " " + answered + "/" + qs.length;
    }

    tab.addEventListener("click", function() { setFilter(t.name); });
    els.tabs.appendChild(tab);
  });
}

// ====== RENDER CARD (safe textContent updates) ======
function renderCard() {
  var qs = filtered();

  if (qs.length === 0) {
    els.cardContent.classList.add("hidden");
    els.emptyState.classList.add("visible");
    els.navPos.textContent = "0 / 0";
    els.prevBtn.disabled = true;
    els.nextBtn.disabled = true;
    return;
  }

  els.emptyState.classList.remove("visible");
  els.cardContent.classList.remove("hidden");

  if (state.currentIndex >= qs.length) state.currentIndex = qs.length - 1;
  if (state.currentIndex < 0) state.currentIndex = 0;

  var q = qs[state.currentIndex];
  var a = getAnswer(q.id);
  currentQuestionId = q.id;

  // Update text content (safe, no innerHTML)
  els.tradeBadge.textContent = q.trade;
  els.tradeBadge.className = "card-trade " + tradeClass(q.trade);
  els.questionId.textContent = q.id;
  els.questionTitle.textContent = q.question;
  els.questionDetail.textContent = q.detail;
  els.whyText.textContent = q.why;
  els.whyDetails.removeAttribute("open");

  // Status buttons
  document.getElementById("btnUnanswered").classList.toggle("active", a.status === "unanswered");
  document.getElementById("btnAnswered").classList.toggle("active", a.status === "answered");
  document.getElementById("btnFollowup").classList.toggle("active", a.status === "follow-up");

  // Answer
  els.answerInput.value = a.answer || "";

  // Mic button state
  els.micBtn.classList.toggle("unavailable", !speechSupported);
  els.micBtn.classList.toggle("recording", isRecording);
  els.micInterim.textContent = "";

  // Voice notes (safe DOM creation)
  while (els.voiceNotes.firstChild) els.voiceNotes.removeChild(els.voiceNotes.firstChild);

  if (a.voiceNotes && a.voiceNotes.length > 0) {
    var details = document.createElement("details");
    details.className = "voice-notes";
    var summary = document.createElement("summary");
    summary.textContent = "Voice notes (" + a.voiceNotes.length + ")";
    details.appendChild(summary);

    a.voiceNotes.forEach(function(vn) {
      var div = document.createElement("div");
      div.className = "voice-note-item";
      var timeSpan = document.createElement("span");
      timeSpan.className = "vn-time";
      timeSpan.textContent = new Date(vn.time).toLocaleTimeString() + " ";
      div.appendChild(timeSpan);
      div.appendChild(document.createTextNode(vn.text));
      details.appendChild(div);
    });

    els.voiceNotes.appendChild(details);
  }

  // Navigation
  els.navPos.textContent = (state.currentIndex + 1) + " / " + qs.length;
  els.prevBtn.disabled = state.currentIndex === 0;
  els.nextBtn.disabled = state.currentIndex >= qs.length - 1;
}

function updateProgress() {
  if (state.filter === "Notes") {
    els.answeredCount.textContent = state.notes.length;
    els.totalCount.textContent = "notes";
  } else {
    var qs = filtered();
    var answered = qs.filter(function(q) { return getAnswer(q.id).status === "answered"; }).length;
    els.answeredCount.textContent = answered;
    els.totalCount.textContent = qs.length;
  }
  renderTabs();
}

// ====== NAVIGATION ======
function setFilter(trade) {
  state.filter = trade;
  state.currentIndex = 0;
  save();
  renderTabs();

  if (trade === "Notes") {
    switchView("notes-list");
  } else {
    switchView("questions");
  }
}

function switchView(view) {
  currentView = view;
  var footer = document.getElementById("footer");
  // Hide all views
  els.card.style.display = "none";
  els.notesView.classList.remove("visible");
  els.noteEditor.classList.remove("visible");
  // Hide/show footer elements
  els.prevBtn.style.display = "none";
  els.nextBtn.style.display = "none";
  els.navPos.style.display = "none";
  els.addNoteBtn.style.display = "none";
  footer.classList.remove("hidden");

  if (view === "questions") {
    els.card.style.display = "";
    els.prevBtn.style.display = "";
    els.nextBtn.style.display = "";
    els.navPos.style.display = "";
    renderCard();
    updateProgress();
  } else if (view === "notes-list") {
    els.notesView.classList.add("visible");
    els.addNoteBtn.style.display = "";
    renderNotesList();
    updateProgress();
  } else if (view === "note-editor") {
    els.noteEditor.classList.add("visible");
    footer.classList.add("hidden");
  }
}

function prevCard() {
  if (state.currentIndex > 0) {
    state.currentIndex--;
    save();
    animateCard("right");
  }
}

function nextCard() {
  if (state.currentIndex < filtered().length - 1) {
    state.currentIndex++;
    save();
    animateCard("left");
  }
}

function animateCard(direction) {
  els.card.classList.add(direction === "left" ? "slide-left" : "slide-right");
  setTimeout(function() {
    renderCard();
    updateProgress();
    els.card.classList.remove("slide-left", "slide-right");
    els.card.classList.add(direction === "left" ? "slide-right" : "slide-left");
    requestAnimationFrame(function() {
      requestAnimationFrame(function() {
        els.card.classList.remove("slide-left", "slide-right");
      });
    });
  }, 120);
}

// ====== STATUS ======
function handleStatus(status) {
  if (!currentQuestionId) return;
  setAnswer(currentQuestionId, { status: status });
  renderCard();
}

document.getElementById("btnUnanswered").addEventListener("click", function() { handleStatus("unanswered"); });
document.getElementById("btnAnswered").addEventListener("click", function() { handleStatus("answered"); });
document.getElementById("btnFollowup").addEventListener("click", function() { handleStatus("follow-up"); });

// ====== ANSWER INPUT ======
var answerDebounce = null;
els.answerInput.addEventListener("input", function() {
  clearTimeout(answerDebounce);
  var id = currentQuestionId;
  answerDebounce = setTimeout(function() {
    if (id) setAnswer(id, { answer: els.answerInput.value });
  }, 300);
});

// ====== SPEECH RECOGNITION â€” DISABLED (froze iOS Safari) ======
var speechSupported = false;
var isRecording = false;
els.micBtn.style.display = "none";

// ====== SWIPE ======
var touchStartX = 0;
var touchStartY = 0;
var touchStartTime = 0;

document.getElementById("cardArea").addEventListener("touchstart", function(e) {
  if (e.target.tagName === "TEXTAREA") return;
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  touchStartTime = Date.now();
}, { passive: true });

document.getElementById("cardArea").addEventListener("touchend", function(e) {
  if (e.target.tagName === "TEXTAREA") return;
  var dx = e.changedTouches[0].clientX - touchStartX;
  var dy = e.changedTouches[0].clientY - touchStartY;
  var dt = Date.now() - touchStartTime;

  if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 1.5 && dt < 500) {
    if (dx < 0) nextCard();
    else prevCard();
  }
}, { passive: true });

// ====== KEYBOARD NAV ======
document.addEventListener("keydown", function(e) {
  if (e.target.tagName === "TEXTAREA" || e.target.tagName === "INPUT") return;
  if (e.key === "ArrowLeft") prevCard();
  if (e.key === "ArrowRight") nextCard();
});

// ====== NAV BUTTONS ======
els.prevBtn.addEventListener("click", prevCard);
els.nextBtn.addEventListener("click", nextCard);

// ====== MENU ======
document.getElementById("menuBtn").addEventListener("click", function() {
  els.menuModal.classList.add("open");
});

els.menuModal.addEventListener("click", function(e) {
  if (e.target === els.menuModal) els.menuModal.classList.remove("open");
});

els.modalSheet.addEventListener("click", function(e) { e.stopPropagation(); });

document.getElementById("btnModalCancel").addEventListener("click", function() {
  els.menuModal.classList.remove("open");
});

// ====== EXPORT ======
document.getElementById("btnExport").addEventListener("click", function() {
  var data = {
    version: 1,
    app: "cwrg-trade-qa",
    exportedAt: new Date().toISOString(),
    questionCount: QUESTIONS.length,
    answers: state.answers,
    notes: state.notes
  };

  var json = JSON.stringify(data, null, 2);
  var blob = new Blob([json], { type: "application/json" });
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "tradespeople-answers.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  els.menuModal.classList.remove("open");
});

// ====== IMPORT ======
document.getElementById("btnImport").addEventListener("click", function() {
  els.importFile.click();
});

els.importFile.addEventListener("change", function(event) {
  var file = event.target.files[0];
  if (!file) return;

  var reader = new FileReader();
  reader.addEventListener("load", function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (data.answers) {
        // Merge: imported answers overwrite local if newer
        Object.keys(data.answers).forEach(function(id) {
          var imported = data.answers[id];
          var local = state.answers[id];
          if (!local || !local.lastModified || (imported.lastModified && imported.lastModified > local.lastModified)) {
            state.answers[id] = imported;
          }
        });
      }
      if (Array.isArray(data.notes)) {
        // Merge notes: match by created timestamp, overwrite if imported is newer
        data.notes.forEach(function(imported) {
          var found = false;
          for (var i = 0; i < state.notes.length; i++) {
            if (state.notes[i].created === imported.created) {
              var impMod = imported.modified || imported.created || "";
              var locMod = state.notes[i].modified || state.notes[i].created || "";
              if (impMod > locMod) state.notes[i] = imported;
              found = true;
              break;
            }
          }
          if (!found) state.notes.push(imported);
        });
      }
      save();
      if (currentView === "questions") {
        renderCard();
      } else if (currentView === "notes-list") {
        renderNotesList();
      }
      updateProgress();
      renderTabs();
    } catch (err) {
      alert("Could not read file: " + err.message);
    }
  });
  reader.readAsText(file);
  event.target.value = "";
  els.menuModal.classList.remove("open");
});

// ====== CLEAR ======
document.getElementById("btnClear").addEventListener("click", function() {
  if (confirm("Clear all answers and notes? This cannot be undone.")) {
    state.answers = {};
    state.notes = [];
    state.currentIndex = 0;
    save();
    if (currentView === "questions") renderCard();
    else if (currentView === "notes-list") renderNotesList();
    updateProgress();
    renderTabs();
    els.menuModal.classList.remove("open");
  }
});

// ====== NOTES ======
var TAG_COLORS = {
  "General": "#475569",
  "Electrician": "#3B82F6",
  "B.C. Heating": "#F59E0B",
  "Client": "#10B981"
};

function renderNotesList() {
  while (els.notesList.firstChild) els.notesList.removeChild(els.notesList.firstChild);

  if (state.notes.length === 0) {
    var empty = document.createElement("div");
    empty.className = "notes-empty";
    var icon = document.createElement("div");
    icon.className = "notes-empty-icon";
    icon.textContent = "\uD83D\uDCDD";
    var msg = document.createElement("div");
    msg.textContent = "No notes yet. Tap + New Note to add one.";
    empty.appendChild(icon);
    empty.appendChild(msg);
    els.notesList.appendChild(empty);
    return;
  }

  // Sort notes newest first
  var sorted = state.notes.slice().sort(function(a, b) {
    return (b.modified || b.created || "").localeCompare(a.modified || a.created || "");
  });

  sorted.forEach(function(note, sortedIdx) {
    // Find real index in state.notes
    var realIndex = state.notes.indexOf(note);

    var item = document.createElement("div");
    item.className = "note-item";
    item.addEventListener("click", function() { openNoteEditor(realIndex); });

    var title = document.createElement("div");
    title.className = "note-item-title";
    title.textContent = note.title || "Untitled note";
    item.appendChild(title);

    if (note.body) {
      var preview = document.createElement("div");
      preview.className = "note-item-preview";
      preview.textContent = note.body;
      item.appendChild(preview);
    }

    var meta = document.createElement("div");
    meta.className = "note-item-meta";
    var dateStr = note.modified || note.created;
    if (dateStr) {
      var d = new Date(dateStr);
      meta.textContent = d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
    }

    if (note.tag) {
      var tag = document.createElement("span");
      tag.className = "note-item-tag";
      tag.textContent = note.tag;
      tag.style.background = TAG_COLORS[note.tag] || TAG_COLORS["General"];
      meta.appendChild(tag);
    }

    item.appendChild(meta);
    els.notesList.appendChild(item);
  });
}

function openNoteEditor(index) {
  currentNoteIndex = index;
  var note = index >= 0 ? state.notes[index] : { title: "", body: "", tag: "General", created: null, modified: null };

  els.noteTitleInput.value = note.title || "";
  els.noteBodyInput.value = note.body || "";
  els.noteDeleteBtn.style.display = index >= 0 ? "" : "none";

  // Set tag buttons
  var tagBtns = els.noteTagRow.querySelectorAll(".note-tag-btn");
  for (var i = 0; i < tagBtns.length; i++) {
    tagBtns[i].classList.toggle("active", tagBtns[i].getAttribute("data-tag") === (note.tag || "General"));
  }

  switchView("note-editor");
  els.noteTitleInput.focus();
}

function getSelectedTag() {
  var active = els.noteTagRow.querySelector(".note-tag-btn.active");
  return active ? active.getAttribute("data-tag") : "General";
}

function saveNote() {
  var title = els.noteTitleInput.value.trim();
  var body = els.noteBodyInput.value.trim();
  if (!title && !body) return; // Don't save empty notes

  var now = new Date().toISOString();
  var tag = getSelectedTag();

  if (currentNoteIndex >= 0) {
    // Update existing
    state.notes[currentNoteIndex].title = title;
    state.notes[currentNoteIndex].body = body;
    state.notes[currentNoteIndex].tag = tag;
    state.notes[currentNoteIndex].modified = now;
  } else {
    // Create new
    state.notes.push({ title: title, body: body, tag: tag, created: now, modified: now });
  }

  save();
  state.filter = "Notes";
  renderTabs();
  switchView("notes-list");
}

function deleteNote() {
  if (currentNoteIndex < 0) return;
  if (!confirm("Delete this note?")) return;
  state.notes.splice(currentNoteIndex, 1);
  currentNoteIndex = -1;
  save();
  renderTabs();
  switchView("notes-list");
}

// Note tag buttons
els.noteTagRow.addEventListener("click", function(e) {
  var btn = e.target.closest(".note-tag-btn");
  if (!btn) return;
  var tagBtns = els.noteTagRow.querySelectorAll(".note-tag-btn");
  for (var i = 0; i < tagBtns.length; i++) tagBtns[i].classList.remove("active");
  btn.classList.add("active");
});

// Note action buttons
els.addNoteBtn.addEventListener("click", function() { openNoteEditor(-1); });
els.noteBackBtn.addEventListener("click", function() {
  state.filter = "Notes";
  renderTabs();
  switchView("notes-list");
});
els.noteSaveBtn.addEventListener("click", saveNote);
els.noteDeleteBtn.addEventListener("click", deleteNote);

// ====== INIT ======
loadState();
renderTabs();
if (state.filter === "Notes") {
  switchView("notes-list");
} else {
  var initQs = filtered();
  if (state.currentIndex >= initQs.length) state.currentIndex = 0;
  switchView("questions");
}
</script>
</body>
</html>
